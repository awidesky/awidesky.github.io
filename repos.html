<!DOCTYPE html>
<html>
<!-- 
    fabicon 추가
-->
<head>
    <title>awidesky.github.io</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <link href="repos.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.4.js"></script>
    <script>
        function findGithubFile(repo, branch, file, callback)
        {
            //404 errors in browser are not hideable.
            //see : https://stackoverflow.com/questions/44019776/fetch-api-chrome-and-404-errors
            fetch("https://raw.githubusercontent.com/awidesky/" + repo + "/" + branch + "/" + file)
            .then(function(response) {
                if(response.ok)
                    callback();
            });
        }
        function urlExists(url, callback) {
            $.ajax({
                type: 'HEAD',
                url: url,
                dataType:"jsonp",
                timeout: "1000",
                crossDomain: true,
                xhrFields: { // this option
                    withCredentials: true,
                },
                statusCode: {
                    200: function () {
                        callback();
                    }
                }
            });
        }
        function downloadObjectAsJson(exportObj, exportName){
          var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj));
          var downloadAnchorNode = document.createElement('a');
          downloadAnchorNode.setAttribute("href",     dataStr);
          downloadAnchorNode.setAttribute("download", exportName + ".json");
          document.body.appendChild(downloadAnchorNode); // required for firefox
          downloadAnchorNode.click();
          downloadAnchorNode.remove();
        }

        $(document).ready(function () {
            $.getJSON('https://api.github.com/users/awidesky/repos',
                function (data) {
                    //downloadObjectAsJson(data, "repos")
                    const repos = document.getElementById("repos");
                    data.sort(function(a, b) {
                        if(a['fork'] == b['fork']) {
                            //both of them are forked, or not forked
                            const da = new Date(a['updated_at']);
                            const db = new Date(b['updated_at']);
                            return da < db ? 1 : (da > db ? -1 : 0);
                        } else {
                            //one of them is forked, the other is not.
                            //the one which is not forked(my own repo)
                            //should be listed first.
                            return a['fork'] == 'false' ? -1 : 1;
                        }
                    });
                    for (let i in data) {
                        //document.write("<br><br>" + data[i]['downloads_url']);
                        if(data[i]['visibility'] !='public') continue;

                        const div = document.createElement("div");

                        const repoLink = document.createElement("a");
                        repoLink.href = data[i]['html_url'];
                        repoLink.innerHTML = "<b>" + data[i]['name'] + "</b>";
                        
                        const releaseLink = document.createElement("a");
                        releaseLink.href = data[i]['html_url'] + "/releases";
                        releaseLink.textContent = "release";
                        
                        const desc = document.createElement("p"); //있을때만!!
                        desc.textContent = data[i]['description']

                        div.appendChild(repoLink);
                        div.appendChild(document.createElement("br"))
                        if(data[i]['description'] != "") div.appendChild(desc)
                        
                        div.appendChild(releaseLink);

                        div.classList.add("repos");
                        repos.appendChild(div);

                        //release 버튼
                        //license
                        //
                        /*
                         {
                            "release": false
                         }
                         */
                        
                        
                        function addMavenDiv() {
                            //denote that it's a maven project
                            //const mavenCentral = "https://central.sonatype.com/artifact/io.github.awidesky/" + data[i]['name'] + "/";
                            //const mavenCentral =                            "http://search.maven.org/solrsearch/select?q=g:\"io.github.awidesky\"+AND+a:" + data[i]['name'] + "&rows=20&wt=json";
                            $.getJSON(mavenCentral, (mavenResp) => {
                                downloadObjectAsJson(mavenResp)
                                if(true) {
                                   const btn = document.createElement("button")
                                   btn.onclick = function() { window.open(mavenCentral) };
                                   btn.textContent = "see in maven central";
                                   div.appendChild(btn);
                                };
                            });
                        }
                        findGithubFile(data[i]['name'], data[i]['default_branch'], "pom.xml", addMavenDiv);
                        
                        /*
                       $.get("https://github.com/awidesky/" + data[i]['name'] + "/blob/" + data[i]['default_branch'] + "/pom.xml")
                            .done(function () {
                                const btn = document.createElement("button")
                                btn.onclick = "window.location='" + maven + "';";
                                btn.textContent = "see in maven central";
                                div.appendChild(btn);
                            });
                         */
                        
                       // alert(httpGet("https://github.com/awidesky/" + data[i]['name'] + "/blob/" + data[i]['default_branch'] + "/pom.xml"))
                        /*function (status) {
                            if (status === 200) {
                                const btn = document.createElement("button")
                                btn.onclick = "window.location='" + maven + "';";
                                btn.textContent = "see in maven central";
                                div.appendChild(btn);
                            } else if (status === 404) {
                                // Execute code if not successful
                            } else {
                                // Execute code if status doesn't match above
                            }
                        */
                        //download 버튼
                        //license
                    }
                }).fail(function(response) {
                    if(response["responseText"].includes("API rate limit")) {
                        window.location.href = 'api_limit.html'
                    } else {
                        alert(JSON.stringify(response, null, 4))
                    }
                });
        });
        //JSON.stringify
    </script>
</head>

<body>
    <div id="repos">
        <h1>My repos</h1>
    </div>
</body>

</html>
