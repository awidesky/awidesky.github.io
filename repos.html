<!DOCTYPE html>
<html>
    <head>
        <title>awidesky.repos</title>
        <link rel="icon" href="favicon.ico" type="image/x-icon" />
        <link href="repos.css" rel="stylesheet" />
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
        <script src="commons.js"></script>
        <script src="repos.js"></script>
        <script>
            $(document).ready(function () {
                $.getJSON('https://api.github.com/users/awidesky', (user) => {
                    let r_num = user.public_repos;
                    var promises = [];
                    let i = 1;
                    while(r_num > 0) {
                        promises.push($.getJSON('https://api.github.com/users/awidesky/repos?per_page=100&page=' + i));
                        /*
                        , function(d,t,jqXHR) {
                            console.log("Remaining api call limit : " + jqXHRs.getResponseHeader("x-ratelimit-remaining")
                                            + ", next limit reset at : " + jqXHRs.getResponseHeader("x-ratelimit-reset")
                        }));
                        */
                        i++;
                        r_num -= 100;
                    }
                    $.when.apply($, promises).then(function(data) {
                        data = [].concat(...data)
                        const comp = (r1, r2) => {
                            d1 = new Date(r1.pushed_at);
                            d2 = new Date(r2.pushed_at);
                            return d1 < d2 ? 1 : (d1 > d2 ? -1 : 0);
                        }
                        const not_forked = data.filter(d => !d.fork);
                        not_forked.sort(comp);
                        const forked = data.filter(d => d.fork);
                        forked.sort(comp);
                        
                        //console.log("Not forked repos : " + not_forked.length + ", Forked repos : " + forked.length);
                        document.getElementById('loading').remove();
                        for (let i in not_forked) { //forEachë¡œ
                            const repoDiv = getRepoDiv(not_forked[i]);
                            readProjectJson(not_forked[i], repoDiv);
                            not_forked[i]['latest_branch'] = not_forked[i]['default_branch']
                            document.getElementById("not_forked_repos").appendChild(repoDiv);
                        }
                        localStorage.setItem("nfRepos", JSON.stringify(not_forked));
                        //TODO(not_forked);
                        for (let i in forked) {
                            document.getElementById("forked_repos")
                                    .appendChild(getRepoDiv(forked[i]));
                        }
                    }, getGithubApiFail(window.location));
                }).fail(getGithubApiFail(window.location));
            });
        </script>
    </head>
    
    <body>
        <div>
            <div style="display: inline-block; width: 100%;">
                <a href="https://github.com/awidesky?tab=repositories" class="plainLink"><h1>My repositories</h1></a>
                <button onclick="location.href = 'TODO.html';" class="TODObtn"><h3>Check TODOs</h3></button>
            </div>
            <div id="loading"><h1><i>Loading...</i></h1></div>
            <div id="not_forked_repos"></div>
            <hr>
            <h2>Forked repositories</h2>
            <div id="forked_repos"></div>
        </div>
        <hr>
        <div id="TODOs"></div>
    </body>
    
</html>
